<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PGR New Starter Roster Creation Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A professional tool for creating new team member training rosters for PGR at The Star Gold Coast." />
  <meta name="theme-color" content="#1a1a1a" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="icon" sizes="192x192" href="https://placehold.co/192x192/png">
  <link rel="icon" sizes="512x512" href="https://placehold.co/512x512/png">

  <style>
    /* --- Modern Font: Inter --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');

    /* --- CSS Variables & Base Styles --- */
    :root {
      --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      --font-serif: 'Cinzel', serif;

      --bg-primary: #0e0e0e;
      --bg-secondary: #181818;
      --bg-tertiary: #242424;
      --surface: #1e1e1e;
      --surface-alt: #131313;
      --bg-gradient: radial-gradient(circle at top left, #1c1c1c 0%, #0b0b0b 100%);

      --text-primary: #f5f5f5;
      --text-secondary: #a3a3a3;
      --text-muted: #737373;

      --border-primary: #404040;
      --border-secondary: #525252;

      --brand-primary: #B92B27; /* Deep Red */
      --brand-secondary: #D4AF37;/* Rich Gold */
      --brand-gradient: linear-gradient(90deg, var(--brand-primary) 0%, #E74C3C 100%);

      --warn-primary: #f59e0b;
      --ok-primary: #22c55e;

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -2px rgb(0 0 0 / 0.1);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { margin: 0; font-family: var(--font-sans); font-size: 14px; line-height: 1.5; color: var(--text-primary); background: var(--bg-gradient); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .app { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    .side { position: sticky; top: 0; height: 100vh; padding: 1.5rem; background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%); border-right: 1px solid var(--border-primary); box-shadow: 2px 0 8px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 2rem; }
    .main { padding: 2rem; display: grid; gap: 1.5rem; align-content: start; }
    .brand { display: flex; align-items: center; gap: 0.75rem; }
    .logo { width: 50px; height: 50px; border-radius: var(--radius-md); }
    .brand .product h1 { font-family: var(--font-serif); font-size: 1.25rem; font-weight: 700; margin: 0; line-height: 1.2; color: var(--brand-secondary); }
      .brand .product .subbrand { font-size: 0.75rem; color: var(--text-secondary); }
      .brand .product .tagline { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
    .nav-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-group h2 { font-family: var(--font-serif); font-size: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin: 0 0 0.5rem; padding: 0 0.5rem; }
    .nav-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .chip { display: inline-flex; align-items: center; padding: 0.375rem 0.75rem; border-radius: var(--radius-md); background-color: var(--bg-tertiary); border: 1px solid var(--border-primary); font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); }
    .toolbar { position: sticky; top: 0; z-index: 10; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; padding: 1rem; margin: -2rem -2rem 0; background: linear-gradient(180deg, rgba(16, 12, 12, 0.95) 70%, transparent 100%); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-primary); }
    #conflicts { margin-left: auto; font-size: 0.875rem; color: var(--text-secondary); background-color: var(--bg-tertiary); padding: 0.5rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--border-primary); }
    .card { background: linear-gradient(180deg, var(--surface) 0%, var(--surface-alt) 100%); border: 1px solid var(--border-primary); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; }
    .card .hd { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-primary); background-color: var(--bg-tertiary); }
    .card .hd h2 { font-family: var(--font-serif); font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin: 0; color: var(--text-secondary); }
    .card .hd .sub { font-size: 0.875rem; color: var(--text-muted); }
    .card .bd { padding: 1.5rem; }
    .grid { display: grid; gap: 1rem; }
    .g2 { grid-template-columns: repeat(2, 1fr); }
    .g3 { grid-template-columns: repeat(3, 1fr); }
    .g4 { grid-template-columns: repeat(4, 1fr); }
    label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; }
    input, textarea, select { width: 100%; font-family: inherit; font-size: 0.875rem; color: var(--text-primary); background-color: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); padding: 0.625rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 4px var(--brand-primary); }
    textarea { min-height: 160px; resize: vertical; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-family: inherit; font-size: 0.875rem; font-weight: 600; padding: 0.625rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--border-secondary); background-color: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; transition: all 0.15s ease-in-out; user-select: none; }
    .btn:hover { background-color: #374151; border-color: #4b5563; }
    .btn:active { transform: scale(0.98); }
    .btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 4px var(--brand-primary); }
    .btn .ico { width: 16px; height: 16px; }
    .btn.primary { background-image: var(--brand-gradient); border: none; color: white; box-shadow: var(--shadow-md); }
    .btn.primary:hover { filter: brightness(1.1); }
    .btn.warn { background-color: #422006; border-color: #78350f; color: var(--warn-primary); }
    .btn.warn:hover { background-color: #522a08; }
    .btn.ghost { background-color: transparent; border-color: transparent; color: var(--text-secondary); }
    .btn.ghost:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .table-wrapper { overflow: auto; border: 1px solid var(--border-primary); border-radius: var(--radius-lg); }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-primary); white-space: nowrap; }
    thead th { position: sticky; top: 0; background-color: var(--bg-tertiary); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); z-index: 2; }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background-color: #2c2c2c; }
    .group-row td { position: sticky; top: 48px; background-color: #222222; font-weight: 700; color: var(--brand-secondary); z-index: 1; }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); }
    .mt-4 { margin-top: 1rem; }
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { background-color: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border-primary); box-shadow: var(--shadow-lg); padding: 2rem; width: 100%; max-width: 400px; transform: scale(0.95); transition: transform 0.3s; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .modal-content h3 { font-family: var(--font-serif); margin: 0 0 0.5rem; font-size: 1.25rem; font-weight: 700; color: var(--brand-secondary); }
    .modal-content p { margin: 0 0 1.5rem; color: var(--text-secondary); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }
    #calendar-modal .modal-content { max-width: 340px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day, .calendar-weekday { display: flex; align-items: center; justify-content: center; height: 36px; border-radius: var(--radius-md); }
    .calendar-weekday { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
    .calendar-day:not(.empty) { cursor: pointer; transition: background-color 0.2s; }
    .calendar-day:not(.empty):hover { background-color: var(--bg-tertiary); }
    .calendar-day.blackout { background-color: var(--brand-primary); color: var(--text-primary); font-weight: 600; }
    @media (max-width: 1024px) { .app { grid-template-columns: 1fr; } .side { position: static; height: auto; border-right: none; border-bottom: 1px solid var(--border-primary); } .toolbar { margin: -2rem -2rem 0; } }
    @media (max-width: 768px) { .main { padding: 1.5rem; } .toolbar { margin: -1.5rem -1.5rem 0; } .g2, .g3, .g4 { grid-template-columns: 1fr; } .card .hd { flex-direction: column; align-items: flex-start; gap: 0.25rem; } }
  </style>
</head>
<body>

<div class="app">
  <aside class="side">
    <div class="brand">
      <img src="logo.png" alt="PGR Logo" class="logo">
      <div class="product">
        <h1>PGR New Starter Roster Creation Tool</h1>
        <div class="subbrand">Private Gaming Rooms</div>
        <div class="tagline">Let's train some newbies!</div>
        <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Created by Patrick Price 2025</div>
        <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Version 7.0</div>
      </div>
    </div>
    <div class="nav-group">
      <h2>Roster Rules</h2>
      <div class="nav-chips"><div class="chip">One shift/day</div><div class="chip">No Sundays</div><div class="chip">Mon off</div><div class="chip">Min 15 shifts</div><div class="chip">≥2 off / 10d</div><div class="chip">Capacity 1/day/outlet</div></div>
    </div>
  </aside>

  <main class="main">
    <div class="toolbar" role="region" aria-label="Global actions">
      <button id="buildAll" class="btn primary" type="button"><svg class="ico" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>Build Roster</button>
      <button id="clearRosterBtn" class="btn" type="button">Clear Roster</button>
      <button id="exportAllCsv" class="btn" type="button"><svg class="ico" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Export CSV</button>
      <button id="exportAllXls" class="btn" type="button"><svg class="ico" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z"/></svg>Export Excel</button>
      <span id="conflicts" aria-live="polite">—</span>
    </div>

    <section class="card" aria-labelledby="starters-h">
      <div class="hd"><h2 id="starters-h">Step 1: Add New Team Members</h2><span class="sub">Add manually or import a CSV file</span></div>
      <div class="bd">
        <div class="grid g3">
          <div><label for="stName">Full Name</label><input id="stName" placeholder="Dakota Parata"></div>
          <div><label for="stId">Staff ID</label><input id="stId" placeholder="123456"></div>
          <div><label for="stDate">First Day of Work</label><input id="stDate" type="date"></div>
        </div>
        <div class="grid g4 mt-4">
          <button id="addStarter" class="btn primary" type="button">Add Person</button>
          <button id="importStartersBtn" class="btn" type="button">Import from CSV</button>
          <button id="exportStartersBtn" class="btn" type="button">Export to CSV</button>
          <button id="clearStarters" class="btn" type="button">Clear All People</button>
          <input type="file" id="importStarters" accept=".csv" class="visually-hidden" />
        </div>
        <div class="mt-4 table-wrapper">
          <table id="startersTbl">
            <thead><tr><th>#</th><th>Name</th><th>Staff ID</th><th>Start Date</th><th>Days Off</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="blocks-h">
      <div class="hd"><h2 id="blocks-h">Step 2: Set Training Shifts</h2><span class="sub">Set how many training shifts each person gets per area</span></div>
      <div class="bd">
        <div class="grid g3">
          <div><label for="blk_food">Oasis Food</label><input type="number" id="blk_food" value="3" min="0"></div>
          <div><label for="blk_obar">Oasis Bar</label><input type="number" id="blk_obar" value="2" min="0"></div>
          <div><label for="blk_floor">SOV South Floor</label><input type="number" id="blk_floor" value="3" min="0" title="Minimum 3 in a row enforced"></div>
          <div><label for="blk_nfloor">SOV North Floor</label><input type="number" id="blk_nfloor" value="1" min="0"></div>
          <div><label for="blk_bar">SOV South Bar</label><input type="number" id="blk_bar" value="1" min="0"></div>
          <div><label for="blk_dining">SOV Dining</label><input type="number" id="blk_dining" value="4" min="0"></div>
        </div>
        <div class="mt-4">
          <label>Randomize Shift Order?</label>
          <button id="shuffleBlocks" class="btn" type="button">Shuffle: OFF</button>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="mandatory-h">
      <div class="hd"><h2 id="mandatory-h">Step 3: Session Days</h2><span class="sub">Choose days for mandatory sessions</span></div>
      <div class="bd">
        <div class="grid g2">
          <div><label for="welcomeDaySel">Welcome Day</label><select id="welcomeDaySel"><option value="1">Monday</option><option value="2" selected>Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select></div>
          <div><label for="onboardDaySel">PGR Onboarding</label><select id="onboardDaySel"><option value="1">Monday</option><option value="2">Tuesday</option><option value="3" selected>Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select></div>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="schedule-h">
      <div class="hd"><h2 id="schedule-h">Step 4: Generated Roster</h2><span class="sub">Click "Build Roster" to see the results here</span></div>
      <div class="bd" style="padding: 0;">
        <div class="table-wrapper">
          <table id="schedTbl">
            <thead><tr><th>Team Member</th><th>Staff ID</th><th>Date</th><th>Start</th><th>End</th><th>Outlet</th><th>Step</th><th>Shift</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Modals -->
<div id="modal" class="modal-overlay"><div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title"><h3 id="modal-title"></h3><p id="modal-text"></p><div class="modal-actions"><button id="modal-cancel" class="btn">Cancel</button><button id="modal-confirm" class="btn primary">Confirm</button></div></div></div>
<div id="calendar-modal" class="modal-overlay"><div class="modal-content"><div class="calendar-header"><button id="prev-month" class="btn ghost">&lt;</button><h3 id="calendar-title"></h3><button id="next-month" class="btn ghost">&gt;</button></div><div class="calendar-grid" id="calendar-weekdays"></div><div class="calendar-grid" id="calendar-days"></div><div class="modal-actions" style="margin-top: 1rem;"><button id="calendar-close" class="btn primary">Done</button></div></div></div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</body>
<script>
// --- APP INITIALIZATION ---
window.onload = () => {
    // --- GLOBAL VARIABLES & CONSTANTS ---
    let starters = [];
    let allRows = [];
    let shuffle = false;
    let modalResolve;
    let activeStarterIndex = -1;
    let currentCalendarDate = new Date();

    const MIN_SHIFTS = 15;
    const MANDATORY_SESSIONS = [
        { name: 'Welcome Day', label: 'Welcome Day', start: '09:00' },
        { name: 'PGR F&B On boarding', label: 'PGR F&B On boarding', start: '09:00' }
    ];
    const RULES = {
        "Oasis Food": ["08:00", "11:00", "16:00"],
        "Oasis Bar": ["06:00", "08:00", "10:00", "14:00", "16:00", "17:00", "18:00", "19:00", "22:00"],
        "SOV South Floor": Array.from({ length: 14 }, (_, k) => (9 + k).toString().padStart(2, '0') + ":00"),
        "SOV North Floor": ["18:00"],
        "SOV South Bar": ["06:00", "10:00", "14:00", "18:00", "22:00"],
        "SOV Dining": ["17:00"]
    };

    // --- HELPER FUNCTIONS ---
    const byId = id => document.getElementById(id);
    const pad2 = n => (n < 10 ? "0" : "") + n;
    const toYMD = d => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    const toDMY = d => `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}/${d.getFullYear()}`;
    const parseYMD = s => { const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); };
    const isMon = d => d.getDay() === 1;
    const isSun = d => d.getDay() === 0;
    const nextWorking = d => { let x = new Date(d); while (isSun(x) || isMon(x)) x.setDate(x.getDate() + 1); return x; };
    function addWorkDay(d) { const x = new Date(d); x.setDate(x.getDate() + 1); return nextWorking(x); }
    function nextDow(startDate, dow, includeStart = true) { const d = new Date(startDate); if (!includeStart) d.setDate(d.getDate() + 1); while (d.getDay() !== dow) d.setDate(d.getDate() + 1); return d; }
    function shuffled(arr) { const a = arr.slice(); for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } return a; }
    function isOutletAllowedOnDate(outlet, dateObj) { const dow = dateObj.getDay(); if (dow === 0) return false; if (outlet === "SOV North Floor") return (dow === 5 || dow === 6); return true; }

    // --- MODAL FUNCTIONS ---
    function showModal(title, text, showCancel = false) {
        const modal = byId('modal');
        byId('modal-title').textContent = title;
        byId('modal-text').textContent = text;
        byId('modal-cancel').style.display = showCancel ? 'inline-flex' : 'none';
        modal.classList.add('visible');
        return new Promise(resolve => { modalResolve = resolve; });
    }

    // --- CORE ROSTERING FUNCTIONS ---
    function isMandatory(r) { return r.Outlet === MANDATORY_SESSIONS[0].label || r.Outlet === MANDATORY_SESSIONS[1].label; }
    function shiftsInLastNDaysFor(starterName, dateObj, n) {
        const start = new Date(dateObj); start.setDate(start.getDate() - (n - 1));
        const startKey = toYMD(start), endKey = toYMD(dateObj);
        let count = 0;
        for (const r of allRows) {
            if (r.Starter !== starterName) continue;
            if (isMandatory(r)) continue;
            if (r.Date >= startKey && r.Date <= endKey) count++;
        }
        return count;
    }
    function canWorkThisDay(starterName, dateObj) { return shiftsInLastNDaysFor(starterName, dateObj, 10) < 8; }

    function lastShiftEnd(starterName) {
        let last = null;
        for (const r of allRows) {
            if (r.Starter !== starterName) continue;
            const d = parseYMD(r.Date);
            const [hh, mm] = r.End.split(":").map(Number);
            d.setHours(hh, mm, 0, 0);
            if (!last || d > last) last = d;
        }
        return last;
    }
    function hasMinRest(starterName, dateObj, startTime) {
        const last = lastShiftEnd(starterName);
        if (!last) return true;
        const start = new Date(dateObj);
        const [hh, mm] = startTime.split(":").map(Number);
        start.setHours(hh, mm, 0, 0);
        return (start - last) >= 12 * 60 * 60 * 1000;
    }

    // --- CALENDAR FUNCTIONS ---
    function renderCalendar() {
        const calendarTitle = byId('calendar-title');
        const calendarDays = byId('calendar-days');
        const weekdaysContainer = byId('calendar-weekdays');
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        calendarTitle.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
        calendarDays.innerHTML = '';
        weekdaysContainer.innerHTML = ['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => `<div class="calendar-weekday">${d}</div>`).join('');
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const starter = starters[activeStarterIndex];
        if (!starter) return;
        for (let i = 0; i < firstDayOfMonth; i++) { calendarDays.innerHTML += `<div class="calendar-day empty"></div>`; }
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = i;
            const dateStr = toYMD(new Date(year, month, i));
            if (starter.blackoutDates.includes(dateStr)) { dayEl.classList.add('blackout'); }
            dayEl.onclick = () => {
                const index = starter.blackoutDates.indexOf(dateStr);
                if (index > -1) { starter.blackoutDates.splice(index, 1); } else { starter.blackoutDates.push(dateStr); }
                renderStarters();
                dayEl.classList.toggle('blackout');
            };
            calendarDays.appendChild(dayEl);
        }
    }

    // --- STARTER MANAGEMENT ---
    function renderStarters() {
        const tb = document.querySelector('#startersTbl tbody');
        if (starters.length === 0) { tb.innerHTML = `<tr><td colspan="6" style="text-align:center; color: var(--text-muted); padding: 2rem;">No starters added yet.</td></tr>`; return; }
        tb.innerHTML = starters.map((s, i) => `<tr><td>${i + 1}</td><td>${s.Name}</td><td>${s.StaffID || 'N/A'}</td><td>${toDMY(parseYMD(s.StartDate))}</td><td>${s.blackoutDates.length} day(s)</td><td style="text-align:right"><button data-i='${i}' class='btn ghost open-calendar' type="button">Calendar</button><button data-i='${i}' class='btn ghost remove-starter' type="button">Remove</button></td></tr>`).join('');
        tb.querySelectorAll('.remove-starter').forEach(b => b.onclick = async () => { const confirmed = await showModal('Confirm Removal', `Are you sure you want to remove ${starters[+b.dataset.i].Name}?`, true); if (confirmed) { starters.splice(+b.dataset.i, 1); renderStarters(); } });
        tb.querySelectorAll('.open-calendar').forEach(b => b.onclick = () => { activeStarterIndex = +b.dataset.i; currentCalendarDate = parseYMD(starters[activeStarterIndex].StartDate); renderCalendar(); byId('calendar-modal').classList.add('visible'); });
    }
    function addStarter() {
        const Name = byId('stName').value.trim(); const StaffID = byId('stId').value.trim(); const StartDate = byId('stDate').value;
        if (!Name || !StartDate) { showModal('Missing Information', 'Both Name and Start Date are required.'); return; }
        starters.push({ Name, StaffID, StartDate, blackoutDates: [] });
        renderStarters();
        byId('stName').value = ''; byId('stId').value = ''; byId('stDate').value = '';
    }
    async function clearStarters() { if (starters.length === 0) { showModal('No Starters', 'There are no starters to clear.'); return; } const confirmed = await showModal('Confirm Clear', 'Are you sure?', true); if (confirmed) { starters = []; renderStarters(); } }
    function importStarters(e) {
        const f = e.target.files[0];
        if (!f) return;
        const fr = new FileReader();
        fr.onload = () => {
            const lines = fr.result.split(/\r?\n/).filter(Boolean);
            lines.shift();
            starters = lines.map(l => { const [Name, StaffID, StartDate] = l.split(','); return { Name, StaffID, StartDate, blackoutDates: [] }; });
            renderStarters();
        };
        fr.readAsText(f);
        e.target.value = null;
    }
    function exportStarters() {
        if (starters.length === 0) { showModal('No Starters', 'There are no starters to export.'); return; }
        const header = ['Name', 'StaffID', 'StartDate'];
        const csv = [header.join(',')].concat(starters.map(s => [s.Name, s.StaffID || '', s.StartDate].join(','))).join('\n');
        download('starters.csv', csv);
    }
    function download(name, text) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text], { type: 'text/plain' })); a.download = name; a.click(); }

    // --- BUILDER & RENDER LOGIC ---
    async function buildAll() {
        if (allRows.length > 0) {
            const confirmed = await showModal('Roster Exists', 'A schedule already exists. Do you want to replace it?', true);
            if (!confirmed) return;
        }
        if (!starters.length) { showModal('Build Error', 'Add at least one starter.'); return; }

        allRows = [];
        const placedByStarter = new Map();
        const placedByStarterOutlet = new Map();

        function incPlaced(starterName, outlet) { placedByStarter.set(starterName, (placedByStarter.get(starterName) || 0) + 1); if (!placedByStarterOutlet.has(starterName)) placedByStarterOutlet.set(starterName, new Map()); const m = placedByStarterOutlet.get(starterName); m.set(outlet, (m.get(outlet) || 0) + 1); }
        function getPlaced(starterName) { return placedByStarter.get(starterName) || 0; }
        function getPlacedOutlet(starterName, outlet) { return placedByStarterOutlet.get(starterName)?.get(outlet) || 0; }
        function addRow(r) { allRows.push(r); incPlaced(r.Starter, r.Outlet); }

        const used = new Set();
        const welcomeDow = +byId('welcomeDaySel').value;
        const onboardDow = +byId('onboardDaySel').value;
        const norm = starters.map(s => { let d = parseYMD(s.StartDate); while (isSun(d)) d.setDate(d.getDate() + 1); return { ...s, NormStart: d }; });
        const groups = {}; for (const s of norm) { const k = toYMD(s.NormStart); (groups[k] ||= []).push(s); }
        for (const dayKey of Object.keys(groups).sort()) {
            let day1 = nextDow(parseYMD(dayKey), welcomeDow);
            let day2 = nextDow(day1, onboardDow, false);
            for (const s of groups[dayKey]) {
                addRow(makeRow(s, day1, MANDATORY_SESSIONS[0].start, MANDATORY_SESSIONS[0].label, 1));
                addRow(makeRow(s, day2, MANDATORY_SESSIONS[1].start, MANDATORY_SESSIONS[1].label, 2));
                s.__state = { currentOutlet: null, remaining: 0, nextDate: addWorkDay(day2) };
            }
        }
        const baseCounts = getBlocks().reduce((m, b) => (m[b.outlet] = b.count, m), {});
        let progress = true, safety = 0; const everyone = Object.values(groups).flat();
        while (progress && safety < 5000) {
            progress = false; safety++;
            for (const s of everyone) {
                if (getPlaced(s.Name) >= MIN_SHIFTS) { s.__state = null; continue; }
                if (!s.__state) continue;
                let st = s.__state; let cur = nextWorking(st.nextDate); let curKey = toYMD(cur);
                let outlet = st.currentOutlet;
                if (st.remaining <= 0) {
                    let candidates = Object.keys(baseCounts).filter(o => getPlacedOutlet(s.Name, o) < baseCounts[o]);
                    if (!candidates.length) { s.__state = null; continue; }
                    if (shuffle) candidates = shuffled(candidates);
                    const allowedToday = candidates.filter(o => !used.has(curKey + "|" + o) && isOutletAllowedOnDate(o, cur));
                    outlet = allowedToday[0] || (shuffle ? shuffled(candidates)[0] : candidates[0]);
                    st.currentOutlet = outlet;
                    st.remaining = Math.max(0, baseCounts[outlet] - getPlacedOutlet(s.Name, outlet));
                }
                while (s.blackoutDates.includes(curKey) || used.has(curKey + "|" + outlet) || !isOutletAllowedOnDate(outlet, cur) || !canWorkThisDay(s.Name, cur) || !hasMinRest(s.Name, cur, pickTime(outlet, allRows.length))) { cur = addWorkDay(cur); curKey = toYMD(cur); if (++safety > 5000) break; }
                const t = pickTime(outlet, allRows.length);
                addRow(makeRow(s, cur, t, outlet, getPlaced(s.Name) + 1));
                used.add(curKey + "|" + outlet);
                st.remaining -= 1; st.nextDate = addWorkDay(cur); progress = true;
            }
        }
        for (const s of everyone) {
            let placed = getPlaced(s.Name); if (placed >= MIN_SHIFTS) continue;
            let last = allRows.filter(r => r.Starter === s.Name).map(r => r.Date).sort().pop();
            let cur = last ? addWorkDay(parseYMD(last)) : nextWorking(s.NormStart);
            let rot = 0, guard = 0; const PREF = ["SOV South Floor", "SOV South Bar", "Oasis Food", "Oasis Bar", "SOV North Floor", "SOV Dining"];
            while (placed < MIN_SHIFTS && guard < 5000) {
                guard++; const key = toYMD(cur);
                if (s.blackoutDates.includes(key)) { cur = addWorkDay(cur); continue; }
                let outlet = PREF.find(o => !used.has(key + "|" + o) && isOutletAllowedOnDate(o, cur));
                if (!outlet || !canWorkThisDay(s.Name, cur) || !hasMinRest(s.Name, cur, pickTime(outlet, rot))) { cur = addWorkDay(cur); continue; }
                const t = pickTime(outlet, rot++);
                addRow(makeRow(s, cur, t, outlet, getPlaced(s.Name) + 1));
                used.add(key + "|" + outlet); placed++; cur = addWorkDay(cur);
            }
        }
        allRows.sort((a, b) => a.Starter.localeCompare(b.Starter) || a.Date.localeCompare(b.Date) || a.Start.localeCompare(b.Start));
        byId('conflicts').textContent = `Built ${allRows.length} shifts for ${starters.length} starter(s)`;
        renderSched(allRows);
    }
    async function clearRoster() {
        if (allRows.length === 0) {
            showModal('Roster Empty', 'There is no schedule to clear.');
            return;
        }
        const confirmed = await showModal('Clear Roster', 'Are you sure you want to clear the entire generated schedule?', true);
        if (confirmed) {
            allRows = [];
            renderSched([]);
            byId('conflicts').textContent = '—';
        }
    }
    function renderSched(rows) {
        const tb = document.querySelector('#schedTbl tbody'); tb.innerHTML = '';
        if (rows.length === 0) { tb.innerHTML = `<tr><td colspan="8" style="text-align:center; color: var(--text-muted); padding: 2rem;">No schedule generated yet.</td></tr>`; return; }
        let curStarter = null;
        for (const r of rows) {
            if (r.Starter !== curStarter) {
                curStarter = r.Starter;
                const trHead = document.createElement('tr'); trHead.className = 'group-row';
                trHead.innerHTML = `<td colspan="8"><b>${r.Starter}</b> &nbsp;&middot;&nbsp; <span class="text-muted">StaffID: ${r.StaffID || 'N/A'}</span></td>`;
                tb.appendChild(trHead);
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.Starter}</td><td>${r.StaffID || 'N/A'}</td><td>${toDMY(parseYMD(r.Date))}</td><td>${r.Start}</td><td>${r.End}</td><td>${r.Outlet}</td><td>${r.Step}</td><td>${r.Shift}</td>`;
            tb.appendChild(tr);
        }
    }
    function getBlocks() { return [{ outlet: "Oasis Food", count: Math.max(0, +byId('blk_food').value || 0) }, { outlet: "Oasis Bar", count: Math.max(0, +byId('blk_obar').value || 0) }, { outlet: "SOV South Floor", count: Math.max(3, +byId('blk_floor').value || 0) }, { outlet: "SOV North Floor", count: Math.max(0, +byId('blk_nfloor').value || 0) }, { outlet: "SOV South Bar", count: Math.max(0, +byId('blk_bar').value || 0) }, { outlet: "SOV Dining", count: Math.max(0, +byId('blk_dining').value || 0) }]; }
    function makeRow(starter, dateObj, start, outlet, step) { const [hh, mm] = start.split(":").map(Number); const endH = (hh + 5) % 24, endM = mm; return { Starter: starter.Name, StaffID: starter.StaffID || '', Date: toYMD(dateObj), Start: start, End: pad2(endH) + ":" + pad2(endM), Outlet: outlet, Step: step, Shift: start.replace(":", "") + "-" + pad2(endH) + pad2(endM) + " " + outlet + " TRN" }; }
    function pickTime(outlet, i) { const times = RULES[outlet] || ["09:00"]; return times[i % times.length]; }

    // --- ATTACH EVENT LISTENERS ---
    byId('modal-cancel').onclick = () => { byId('modal').classList.remove('visible'); if (modalResolve) modalResolve(false); };
    byId('modal-confirm').onclick = () => { byId('modal').classList.remove('visible'); if (modalResolve) modalResolve(true); };
    byId('modal').onclick = (e) => { if (e.target === byId('modal')) { byId('modal').classList.remove('visible'); if (modalResolve) modalResolve(false); } };
    byId('prev-month').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); };
    byId('next-month').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); };
    byId('calendar-close').onclick = () => byId('calendar-modal').classList.remove('visible');
    byId('calendar-modal').onclick = (e) => { if (e.target === byId('calendar-modal')) byId('calendar-modal').classList.remove('visible'); };
    byId('addStarter').onclick = addStarter;
    byId('clearStarters').onclick = clearStarters;
    byId('importStartersBtn').onclick = () => byId('importStarters').click();
    byId('importStarters').onchange = importStarters;
    byId('exportStartersBtn').onclick = exportStarters;
    byId('shuffleBlocks').onclick = () => {
        shuffle = !shuffle;
        const btn = byId('shuffleBlocks');
        btn.textContent = 'Shuffle: ' + (shuffle ? 'ON' : 'OFF');
        btn.style.borderColor = shuffle ? 'var(--brand-secondary)' : 'var(--border-secondary)';
    };
    byId('buildAll').onclick = buildAll;
    byId('clearRosterBtn').onclick = clearRoster;
    byId('exportAllCsv').onclick = () => { if (!allRows.length) { showModal('Export Error', 'Build a schedule first.'); return; } const header = ['Starter', 'StaffID', 'Date', 'Start', 'End', 'Outlet', 'Step', 'Shift']; const csv = [header.join(',')].concat(allRows.map(r => [r.Starter, r.StaffID || '', toDMY(parseYMD(r.Date)), r.Start, r.End, r.Outlet, r.Step, r.Shift].join(','))).join('\n'); download('schedules.csv', csv); };
    byId('exportAllXls').onclick = () => { if (!allRows.length) { showModal('Export Error', 'Build a schedule first.'); return; } const wsSchedule = XLSX.utils.json_to_sheet(allRows.map(r => ({ Starter: r.Starter, StaffID: r.StaffID || '', Date: toDMY(parseYMD(r.Date)), Start: r.Start, End: r.End, Outlet: r.Outlet, Step: r.Step, Shift: r.Shift }))); const wsStarters = XLSX.utils.json_to_sheet(starters.map(s => ({ Name: s.Name, StaffID: s.StaffID || '', StartDate: s.StartDate }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, wsSchedule, "Roster"); XLSX.utils.book_append_sheet(wb, wsStarters, "Starters"); XLSX.writeFile(wb, "roster_and_starters.xlsx"); };

    // --- INITIAL SETUP ---
    renderStarters();
    renderSched([]);
};

/* --- PWA: register service worker --- */
if("serviceWorker" in navigator && window.location.protocol === 'https:') {
  navigator.serviceWorker.register('sw.js').catch(error => {
    console.warn('Service Worker registration failed:', error);
  });
}
</script>
</html>
